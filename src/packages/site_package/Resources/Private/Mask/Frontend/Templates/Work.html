<main class="pt-52">
    <!-- Animations for filtering -->
    <style>
        /* Smooth hide/show animations (works fine with Tailwind) */
        figure[data-category-uid] {
            transition: opacity 300ms ease, transform 300ms ease, visibility 300ms ease;
            will-change: opacity, transform;
        }
        /* while hiding */
        .is-hiding {
            opacity: 0;
            transform: scale(0.98) translateY(8px);
            visibility: hidden;
            pointer-events: none;
        }
        /* fully removed from layout after transition */
        .is-hidden {
            display: none !important;
        }
        /* optional: tiny stagger via CSS variable */
        figure[data-category-uid] {
            transition-delay: var(--stagger, 0ms);
        }
    </style>
    <!-- Page container -->
    <div class="mx-auto bg-white px-0 sm:px-4 ">
        <div class="filter flex justify-end px-4">
            <div class="filter-content flex justify-end">
                <ul class="flex justify-end pb-4 gap-7 ulnav">
                    <li>
                        <a href="#all" class="hover:italic" data-category-main-uid="0">Alle</a>
                    </li>
                    <li>
                        <a href="#architecture" class="hover:italic" data-category-main-uid="2">Architektur</a>
                    </li>
                    <li>
                        <a href="#stories" class="hover:italic" data-category-main-uid="3">Stories</a>
                    </li>
                    <li style="margin-right: 2px">
                        <a href="#portraits" class="hover:italic" data-category-main-uid="4">Portraits</a>
                    </li>
                </ul>
            </div>
        </div>
        <!-- Grid: mobile 1 col, tablet 2 cols, desktop 3 cols -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 px-0 herecheckman gap-0">
                <f:if condition="{data.tx_mask_all_cases}">
                    <f:for each="{data.tx_mask_all_cases}" as="data_item" iteration="it">

                        <!-- z-index logic -->
                        <f:if condition="{it.cycle}<4">
                            <figure class="relative group mb-6 {f:if(condition: '{it.cycle} == 1', then: 'z-0')} {f:if(condition: '{it.cycle} == 2', then: 'z-0 hidden sm:block')} {f:if(condition: '{it.cycle} == 3', then: 'z-0 hidden lg:block')}" data-category-uid="{data_item.tx_mask_catgeory_items.0.uid}">
                                <f:if condition="{data_item.tx_mask_link_for_image}">
                                    <f:link.typolink parameter="{data_item.tx_mask_link_for_image}" class="block overflow-hidden">
                                        <f:for each="{data_item.tx_mask_photo_case}" as="file">
                                            <f:image
                                                    image="{file}"
                                                    width="1000c"
                                                    height="1370c"
                                                    class="w-full block h-auto object-cover transition-transform duration-300 group-hover:scale-[1.01]"
                                                    loading="lazy"
                                            />
                                        </f:for>
                                    </f:link.typolink>
                                </f:if>

                                <figcaption class="pointer-events-none absolute left-3 bottom-0 text-[10px] sm:text-xs text-lime-200 caption-shadow  transition-opacity duration-150 block sm:hidden sm:group-hover:block">
                                    <f:if condition="{data_item.tx_mask_text_on_image}">
                                        {data_item.tx_mask_text_on_image -> f:transform.html()}
                                    </f:if>
                                </figcaption>
                            </figure>
                        </f:if>
                    </f:for>
                </f:if>
        </div>

        <!-- Grid: mobile 1 col, tablet 2 cols, desktop 3 cols -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 bg-white relative z-30 pb-8 px-0 gap-0">
            <f:if condition="{data.tx_mask_all_cases}">
                <f:for each="{data.tx_mask_all_cases}" as="data_item" iteration="it">
                    <f:if condition="{it.cycle}>=2">
                        <!-- z-index logic -->
                        <figure class="relative group mb-6 z-20 {f:if(condition: '{it.cycle} == 2', then: 'z-0 block sm:hidden')} {f:if(condition: '{it.cycle} == 3', then: 'block lg:hidden')}" data-category-uid="{data_item.tx_mask_catgeory_items.0.uid}">
                            <f:if condition="{data_item.tx_mask_link_for_image}">
                                <f:link.typolink parameter="{data_item.tx_mask_link_for_image}" class="block overflow-hidden">
                                    <f:for each="{data_item.tx_mask_photo_case}" as="file">
                                        <f:image
                                                image="{file}"
                                                width="1000c"
                                                height="1370c"
                                                class="w-full block h-auto object-cover transition-transform duration-300 group-hover:scale-[1.01]"
                                                loading="lazy"
                                        />
                                    </f:for>
                                    <figcaption class="pointer-events-none absolute left-3 bottom-0 text-[10px] sm:text-xs text-lime-200 caption-shadow  transition-opacity duration-150 block sm:hidden group-hover:block">
                                        <f:if condition="{data_item.tx_mask_text_on_image}">
                                            {data_item.tx_mask_text_on_image -> f:transform.html()}
                                        </f:if>
                                    </figcaption>
                                </f:link.typolink>
                            </f:if>

                        </figure>
                    </f:if>
                </f:for>
            </f:if>
        </div>

    </div>
</main>

<script>
    (function () {
    const nav = document.querySelector('.ulnav');
    if (!nav) return;

    const figures = Array.from(document.querySelectorAll('figure[data-category-uid]'));
    if (!figures.length) return;

    // Wstrzyknij minimalny CSS dla overlay (raz)
    (function injectStyleOnce(){
        const id = 'work-filter-overlay-style';
        if (document.getElementById(id)) return;
        const style = document.createElement('style');
        style.id = id;
        style.textContent = `
        .figure-filter-overlay {
            position: absolute;
            inset: 0;
            background: #C3D2E2;
            background: white;
            opacity: 0;
            pointer-events: none;
            transition: opacity 200ms ease;
        }
        .figure-filter-overlay.is-active {
            opacity: .8;
            pointer-events: auto;
        }
        `;
        document.head.appendChild(style);
    })();

    // Upewnij się, że każde figure ma relatywny kontekst dla overlay
    figures.forEach(fig => {
        const cs = getComputedStyle(fig);
        if (cs.position === 'static') {
            fig.style.position = 'relative';
        }
        if (!fig.querySelector('.figure-filter-overlay')) {
            const ov = document.createElement('div');
            ov.className = 'figure-filter-overlay';
            fig.appendChild(ov);
        }
    });

    const container = figures[0]?.parentElement;
    let overlayEnabled = false; // dopiero po wyborze kategorii != '0'

    function getColumnCount() {
        if (!container) return 1;

        const fromAttr = parseInt(container.dataset.columns || '', 10);
        if (!Number.isNaN(fromAttr) && fromAttr > 0) return fromAttr;

        const style = getComputedStyle(container);
        const gtc = style.gridTemplateColumns;

        if (gtc && gtc !== 'none') {
            const rep = gtc.match(/repeat\((\d+)\s*,/);
            if (rep) return parseInt(rep[1], 10);
            const parts = gtc.trim().split(/\s+(?![^(]*\))/);
            if (parts.length > 0) return parts.length;
        }
        return 1;
    }

    function setActiveLink(activeUid) {
        nav.querySelectorAll('a[data-category-main-uid]').forEach(a => {
            a.classList.toggle('italic', a.dataset.categoryMainUid === activeUid);
        });
    }

    function applyZForIndex(fig, i, cols) {
        fig.classList.toggle('z-0', i < cols);
        fig.classList.toggle('z-20', i >= cols);
    }

    // Włącz/wyłącz linki w figure (klawiatura + semantyka)
    function setDisabled(fig, disabled) {
        const links = fig.querySelectorAll('a');
        links.forEach(a => {
            if (disabled) {
                a.setAttribute('aria-disabled', 'true');
                if (!a.hasAttribute('data-prev-tabindex')) {
                    const prev = a.getAttribute('tabindex');
                    a.setAttribute('data-prev-tabindex', prev == null ? '' : prev);
                }
                a.setAttribute('tabindex', '-1');
            } else {
                a.removeAttribute('aria-disabled');
                const prev = a.getAttribute('data-prev-tabindex');
                if (prev === '') a.removeAttribute('tabindex');
                else if (prev != null) a.setAttribute('tabindex', prev);
                a.removeAttribute('data-prev-tabindex');
            }
        });
    }

    function applyOverlay(fig, active) {
        const ov = fig.querySelector('.figure-filter-overlay');
        if (!ov) return;
        ov.classList.toggle('is-active', active);
        setDisabled(fig, active); // spójnie z overlay
    }

    function clearAllOverlays() {
        figures.forEach(fig => applyOverlay(fig, false));
    }

    function applyFilter(uid) {
        const showAll = uid === '0';
        setActiveLink(uid);

        const cols = getColumnCount();
        figures.forEach((fig, i) => applyZForIndex(fig, i, cols));

        // Overlay tylko gdy włączony i nie "All"
        if (!overlayEnabled || showAll) {
            clearAllOverlays();
            return;
        }

        figures.forEach((fig) => {
            const match = fig.dataset.categoryUid === uid;
            applyOverlay(fig, !match); // żółty + blokada na NIEpasujących
        });
    }

    function reapplyZIndexForCurrent() {
        const cols = getColumnCount();
        figures.forEach((fig, i) => applyZForIndex(fig, i, cols));
    }

    nav.addEventListener('click', (e) => {
        const a = e.target.closest('a[data-category-main-uid]');
        if (!a) return;
        e.preventDefault();
        const uid = a.dataset.categoryMainUid || '0';
        overlayEnabled = uid !== '0'; // włącz po wyborze kategorii
        applyFilter(uid);
        if (a.getAttribute('href')) {
            history.replaceState(null, '', a.getAttribute('href'));
        }
    });

    // Start: bez overlay i bez blokad; poprawny z-index
    const initial = nav.querySelector('a[data-category-main-uid].italic')?.dataset.categoryMainUid
        || (location.hash && location.hash.replace('#', '')) || '0';
    setActiveLink(initial);
    reapplyZIndexForCurrent();
    clearAllOverlays();

    // Reaguj na zmianę layoutu (np. resize -> inna liczba kolumn)
    let resizeRaf = 0;
    window.addEventListener('resize', () => {
        if (resizeRaf) cancelAnimationFrame(resizeRaf);
        resizeRaf = requestAnimationFrame(() => {
            reapplyZIndexForCurrent();
        });
    });
})();
</script>